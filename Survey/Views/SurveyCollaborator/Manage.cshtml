@model ManageCollaboratorsViewModel
@{
    ViewData["Title"] = "Manage Collaborators";
}

<div class="container" style="max-width: 1000px; padding: 24px;">
    <div class="card-surface" style="padding: 24px; border-radius: 12px;">
        <!-- Header -->
        <div style="margin-bottom: 24px;">
            <h1 class="md-typescale-headline-large">Manage Collaborators</h1>
            <p class="md-typescale-body-large" style="color: var(--md-sys-color-on-surface-variant); margin-top: 8px;">
                Survey: <strong>@Model.SurveyTitle</strong>
            </p>
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success" style="padding: 12px; margin-bottom: 16px; background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border-radius: 8px;">
                @TempData["SuccessMessage"]
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-error" style="padding: 12px; margin-bottom: 16px; background-color: rgba(179, 38, 30, 0.1); color: var(--md-sys-color-error); border-radius: 8px;">
                @TempData["ErrorMessage"]
            </div>
        }

        <!-- Add Collaborator Form -->
        <div style="background-color: var(--md-sys-color-surface-variant); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
            <h2 class="md-typescale-title-large" style="margin-bottom: 16px;">Add New Collaborator</h2>
            <form asp-action="Add" asp-controller="SurveyCollaborator" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="AddForm.SurveyId" />
                
                <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 12px; align-items: start;">
                    <div>
                        <md-outlined-text-field 
                            label="Email Address"
                            name="Email"
                            type="email"
                            required
                            style="width: 100%;">
                        </md-outlined-text-field>
                    </div>
                    
                    <div>
                        <select name="Role" required 
                                style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 4px; background: var(--md-sys-color-surface); font-family: Roboto;">
                            <option value="">Select Role</option>
                            <option value="Editor">Editor</option>
                            <option value="Viewer">Viewer</option>
                        </select>
                    </div>
                    
                    <md-filled-button type="submit">
                        <span class="material-symbols-outlined" slot="icon">person_add</span>
                        Add
                    </md-filled-button>
                </div>
            </form>
        </div>

        <!-- Collaborators List -->
        <h2 class="md-typescale-title-large" style="margin-bottom: 16px;">Current Collaborators (@Model.Collaborators.Count)</h2>
        
        @if (Model.Collaborators.Any())
        {
            <div style="display: grid; gap: 12px;">
                @foreach (var collaborator in Model.Collaborators)
                {
                    <div class="card-surface" style="padding: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <!-- Avatar -->
                            <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-secondary)); display: flex; align-items: center; justify-content: center;">
                                @if (!string.IsNullOrEmpty(collaborator.AvatarUrl))
                                {
                                    <img src="@collaborator.AvatarUrl" alt="@collaborator.FullName" style="width: 100%; height: 100%; object-fit: cover;" />
                                }
                                else
                                {
                                    <span style="color: white; font-weight: 600; font-size: 18px;">
                                        @(collaborator.FullName.Split(' ').FirstOrDefault()?.Substring(0, 1).ToUpper() ?? "?")
                                    </span>
                                }
                            </div>
                            
                            <!-- Info -->
                            <div>
                                <div class="md-typescale-title-medium">@collaborator.FullName</div>
                                <div class="md-typescale-body-small" style="color: var(--md-sys-color-on-surface-variant);">
                                    @collaborator.Email
                                </div>
                                <div class="md-typescale-body-small" style="color: var(--md-sys-color-on-surface-variant); margin-top: 4px;">
                                    Joined: @collaborator.GrantedAtUtc.ToString("MMM dd, yyyy")
                                    @if (!string.IsNullOrEmpty(collaborator.GrantedByName))
                                    {
                                        <span> • Invited by: @collaborator.GrantedByName</span>
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <!-- Role & Actions -->
                        <div style="display: flex; align-items: center; gap: 12px;">
                            @if (collaborator.Role == "Owner")
                            {
                                <span style="padding: 8px 16px; background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border-radius: 16px; font-weight: 500;">
                                    <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">verified_user</span>
                                    Owner
                                </span>
                            }
                            else
                            {
                                <form asp-action="UpdateRole" asp-controller="SurveyCollaborator" method="post" style="display: inline;">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="SurveyId" value="@Model.SurveyId" />
                                    <input type="hidden" name="UserId" value="@collaborator.UserId" />
                                    <select name="NewRole" onchange="this.form.submit()" 
                                            style="padding: 8px 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 16px; background: var(--md-sys-color-surface); font-family: Roboto;">
                                        <option value="Editor" selected="@(collaborator.Role == "Editor")">Editor</option>
                                        <option value="Viewer" selected="@(collaborator.Role == "Viewer")">Viewer</option>
                                    </select>
                                </form>
                                
                                <form asp-action="Remove" asp-controller="SurveyCollaborator" method="post" style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to remove this collaborator?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="surveyId" value="@Model.SurveyId" />
                                    <input type="hidden" name="userId" value="@collaborator.UserId" />
                                    <md-icon-button type="submit">
                                        <span class="material-symbols-outlined">person_remove</span>
                                    </md-icon-button>
                                </form>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div style="text-align: center; padding: 48px; color: var(--md-sys-color-on-surface-variant);">
                <span class="material-symbols-outlined" style="font-size: 64px; opacity: 0.5;">group_off</span>
                <p class="md-typescale-body-large" style="margin-top: 16px;">No collaborators yet</p>
            </div>
        }
    </div>
</div>