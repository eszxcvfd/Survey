@model EditProfileDto
@{
    ViewData["Title"] = "Edit Profile";
}

<section class="auth-card card-surface" style="max-width: 600px;">
    <h2 class="md-typescale-headline-medium">Edit Profile</h2>
    
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" style="padding: 12px; margin-bottom: 16px; background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border-radius: 8px;">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-error" style="padding: 12px; margin-bottom: 16px; background-color: rgba(179, 38, 30, 0.1); color: var(--md-sys-color-error); border-radius: 8px;">
            <div asp-validation-summary="ModelOnly"></div>
        </div>
    }

    <form asp-action="Profile" asp-controller="Manage" method="post" enctype="multipart/form-data" novalidate>
        @Html.AntiForgeryToken()

        <!-- Avatar Preview -->
        <div style="text-align: center; margin-bottom: 24px;">
            <div id="avatarContainer" style="width: 120px; height: 120px; margin: 0 auto 16px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-secondary)); display: flex; align-items: center; justify-content: center; position: relative;">
                @if (!string.IsNullOrEmpty(Model.CurrentAvatarUrl))
                {
                    <img id="avatarPreview" src="@Model.CurrentAvatarUrl" alt="Current Avatar" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;" />
                }
                else
                {
                    <span class="avatar-initials" id="avatarInitials" style="font-size: 48px; color: var(--md-sys-color-on-primary); font-weight: 600; z-index: 1;">
                        @{
                            var initials = "U";
                            if (!string.IsNullOrEmpty(Model.FullName))
                            {
                                var parts = Model.FullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
                                if (parts.Length == 1)
                                {
                                    initials = parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
                                }
                                else if (parts.Length > 1)
                                {
                                    initials = (parts[0][0].ToString() + parts[^1][0].ToString()).ToUpper();
                                }
                            }
                        }
                        @initials
                    </span>
                }
            </div>
            
            <label for="avatarInput" style="cursor: pointer;">
                <md-outlined-button type="button" onclick="document.getElementById('avatarInput').click()">
                    <span class="material-symbols-outlined" slot="icon">upload</span>
                    Change Avatar
                </md-outlined-button>
            </label>
            <input type="file" 
                   id="avatarInput" 
                   name="AvatarImage" 
                   accept="image/*" 
                   style="display: none;" 
                   onchange="previewAvatar(this)" />
            <p class="md-typescale-body-small" style="margin-top: 8px; color: var(--md-sys-color-on-surface-variant);">
                JPG, JPEG, PNG, or GIF (Max 5MB)
            </p>
        </div>

        <div class="form-row">
            <md-outlined-text-field label="Full Name"
                                    name="FullName"
                                    value="@Model.FullName"
                                    required>
            </md-outlined-text-field>
            <span asp-validation-for="FullName" class="text-danger md-typescale-body-small"></span>
        </div>

        <div class="form-actions">
            <md-filled-button type="submit">Save Changes</md-filled-button>
            <md-outlined-button type="button" onclick="window.location.href='@Url.Action("ChangePassword","Manage")'">
                Change Password
            </md-outlined-button>
        </div>
    </form>
</section>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                // Validate file type
                const file = input.files[0];
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                
                if (!validTypes.includes(file.type)) {
                    alert('Please select a valid image file (JPG, PNG, or GIF)');
                    input.value = '';
                    return;
                }
                
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must not exceed 5MB');
                    input.value = '';
                    return;
                }
                
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    var container = document.getElementById('avatarContainer');
                    var initials = document.getElementById('avatarInitials');
                    var preview = document.getElementById('avatarPreview');
                    
                    if (!preview) {
                        // Create new image element
                        preview = document.createElement('img');
                        preview.id = 'avatarPreview';
                        preview.style.width = '100%';
                        preview.style.height = '100%';
                        preview.style.objectFit = 'cover';
                        preview.style.position = 'absolute';
                        preview.style.top = '0';
                        preview.style.left = '0';
                        container.appendChild(preview);
                    }
                    
                    preview.src = e.target.result;
                    
                    // Hide initials
                    if (initials) {
                        initials.style.display = 'none';
                    }
                }
                
                reader.readAsDataURL(file);
            }
        }
    </script>
}